// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client"
  output          = "../generated/prisma"
  //moduleFormat    = "cjs"
}

datasource db {
  provider = "postgresql"
}

// ============ 1. USER & AUTH ============//
enum Vaitro {
  ADMIN
  TEACHER
  PARENT
}

model User {
  ID       Int    @id @default(autoincrement())
  Email    String? @unique
  DienThoai String? @unique
  
  MatKhauHash String
  PhaiDoiMK Boolean @default(true)//bắt buộc đổi mật khẩu lần đầu đăng nhập
  VaiTro   Vaitro 
  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @updatedAt

  //Quan hệ
  GiaoVien GiaoVien?//là giáo viên
  HocVien HocVien[] //phụ huynh của nhiều học viên
}


// ============ 2. GIAOVIEN ============//
enum TrangThaiGV {
  ACTIVE
  INACTIVE
}

model GiaoVien{
  ID        Int   @id @default(autoincrement())
  MaGiaoVien String @unique
  UserID   Int @unique 

  HoTen     String
  ChuyenMon String?
  GhiChu    String?
  TrangThai TrangThaiGV @default(ACTIVE) //thêm mới là ACTIVE
  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @updatedAt

  //Quan hệ
  User     User  @relation(fields: [UserID], references: [ID])
  LopHoc  LopHoc[] //giáo viên dạy nhiều lớp học
  KetQua_BuoiHoc KetQua_BuoiHoc[] //giáo viên ghi kết quả nhiều buổi học
}

// ============ 3. HOCVIEN ============//
enum TrangThaiHV {
  ACTIVE
  INACTIVE
}

model HocVien{
  ID        Int   @id @default(autoincrement())
  MaHocVien String @unique
  UserID   Int //id phụ huynh
  
  TenHocVien String
  TenPhuHuynh String
  NgaySinh  DateTime
  DiaChi    String?
  GhiChu    String?
  TrangThai TrangThaiHV @default(ACTIVE) //thêm mới là ACTIVE

  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @updatedAt

  //Quan hệ
  Parent User @relation(fields: [UserID], references: [ID])
  Ghidanh GhiDanh[] //lớp học có nhiều học viên ghi danh
}

// ============ 4. KHOAHOC ============//
enum TrangThaiKH {
  DRAFT
  AcTIVE
  INACTIVE
}
model KhoaHoc{
  ID        Int   @id @default(autoincrement())
  MaKhoaHoc String @unique
  
  TenKhoaHoc String
  TrinhDo   String
  ThoiGian  Int //tổng thời gian khóa học (giờ)
  TongSoBuoi Int
  HocPhi    Decimal @db.Decimal(10,2)
  TrangThai TrangThaiKH @default(DRAFT) //mặc định là DRAFT
  MoTa      String?
  
  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @updatedAt

  //Quan hệ
  lophoc LopHoc[] //khóa học có nhiều lớp học
}

// ============ 5. LOPHOC ============//
enum TrangThaiLH {
  OPEN
  RUNNING
  CLOSED
}
model LopHoc{
  ID        Int   @id @default(autoincrement())
  
  MaLopHoc String @unique
  KhoaHocID Int
  GiaoVienID Int

  TenLop   String
  MoTa     String?
  TuNgay   DateTime
  DenNgay  DateTime
  LichHoc  Int[] //[1,3,5] Thứ 2,4,6
  GioBatDau String //"18:00"
  GioKetThuc String //"20:00"
  SiSo     Int
  TrangThai TrangThaiLH @default(OPEN) //mặc định là OPEN
  CreatedAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  //Quan hệ
  khoahoc KhoaHoc @relation(fields: [KhoaHocID], references: [ID]) // lớp học thuộc về khóa học
  giaovien GiaoVien @relation(fields: [GiaoVienID], references: [ID]) // lớp học do giáo viên phụ trách
  buoihoc BuoiHoc[]//lớp học có nhiều buổi học
  ghidanh GhiDanh[]// lớp học có nhiều học viên ghi danh
}

// ============ 6. BUOIHOC ============//
enum TrangThaiBH {
  SCHEDULED
  COMPLETED
  CANCELED
}
model BuoiHoc{
  ID        Int   @id @default(autoincrement())
  LopHocID Int 

  BuoiSo   Int
  ChuDe    String?
  PhongHoc  String?
  BatDauLuc DateTime
  KetThucLuc DateTime
  MoTa     String?
  TrangThai TrangThaiBH @default(SCHEDULED) //mặc định là SCHEDULE

  CreatedAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  //Quan hệ
  @@unique([LopHocID, BatDauLuc]) //một lớp học không có hai buổi học cùng thời gian bắt đầu
  lophoc LopHoc @relation(fields: [LopHocID], references: [ID]) //buổi học thuộc về lớp học
  ketqua_buoihoc KetQua_BuoiHoc? //buổi học có kết quả buổi học
}

// ============ 7. KETQUA_BUOIHOC ============//
enum TrangThai_KQBH {
  DRAFT
  SUBMITTED
}
model KetQua_BuoiHoc{
  ID  Int   @id @default(autoincrement())
  //BuoiHocID, GiaoVienID, NhanXetChung, TrangThai
  BuoiHocID Int @unique
  GiaoVienID Int
  NhanXetChung String
  TrangThai TrangThai_KQBH @default(DRAFT) //mặc định là DRAFT
  
  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @updatedAt

  //Quan hệ
  buoihoc BuoiHoc @relation(fields: [BuoiHocID], references: [ID])
  giaovien GiaoVien @relation(fields: [GiaoVienID], references: [ID])
  ketqua_chitiet KetQua_ChiTiet[] //kết quả buổi học có nhiều kết quả chi tiết
}

// ============ 8. KETQUA_CHITIET ============//
model KetQua_ChiTiet{
  ID        Int   @id @default(autoincrement())
  KetQuaID Int 
  GhiDanhID Int
  NhanXetRieng String?
  DiemDanh  Boolean @default(false) //mặc định là điểm danh có mặt
  
  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @updatedAt

  //Quan hệ
  @@unique([KetQuaID, GhiDanhID]) //một kết quả buổi học chỉ có một chi tiết cho mỗi ghi danh 
  ketqua_buoihoc KetQua_BuoiHoc @relation(fields: [KetQuaID],references: [ID])
  ghidanh GhiDanh @relation(fields: [GhiDanhID], references: [ID])
}

// ============ 9. GHIDANH ============//
enum TrangThai_GD {
  PENDING
  ACTIVE
  STOPPED
}
model GhiDanh{
  ID        Int   @id @default(autoincrement())
  
  HocVienID Int 
  LopHocID  Int
  NgayGhiDanh DateTime
  GhiChu    String?
  TrangThai TrangThai_GD @default(PENDING) //mặc định là PENDING
  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @updatedAt

  //Quan hệ
  @@unique([HocVienID, LopHocID]) //một học viên chỉ được ghi danh một lần vào một lớp học
  hocvien HocVien @relation(fields: [HocVienID], references: [ID])
  lophoc LopHoc @relation(fields: [LopHocID], references: [ID])
  ketqua_chitiet KetQua_ChiTiet[] //ghi danh có nhiều kết quả chi tiết
  hoadon HoaDon? //1 ghi danh có 1 hóa đơn
}

// ============ 10. HOADON  ============//
model HoaDon{
  ID        Int   @id @default(autoincrement())
  MaHoaDon String @unique
  GhiDanhID Int @unique
  TongTien Decimal @db.Decimal(10,2)
  DaTra    Decimal @db.Decimal(10,2) @default(0)
  ThoiHan  DateTime
  GhiChu   String?

  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @updatedAt

  //Quan hệ
  ghidanh GhiDanh @relation(fields: [GhiDanhID], references: [ID])
  phieuthu PhieuThu[] //hóa đơn có nhiều phiếu thu
}

// ============ 11. PHIEUTHU  ============//
model PhieuThu{
  ID        Int   @id @default(autoincrement())
  MaPhieuThu String @unique
  HoaDonID Int
  SoTien   Decimal @db.Decimal(10,2)
  NgayThu   DateTime
  GhiChu   String?

  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @updatedAt

  //Quan hệ
  hoadon HoaDon @relation(fields: [HoaDonID], references: [ID])
}